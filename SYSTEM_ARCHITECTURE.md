# ğŸ—ï¸ WebProMetrics Pricing System - Architecture Diagram

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND (React)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚            PricingPageEnhanced Component                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  Hero Section: "Pricing That Scales With You"      â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚   â”‚
â”‚  â”‚  â”‚ Starter  â”‚  Agency  â”‚ Enterprise â”‚  (3 Pricing Cards)   â”‚   â”‚
â”‚  â”‚  â”‚ KES 2,5  â”‚ KES 7,5  â”‚  Custom    â”‚                       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚   â”‚
â”‚  â”‚  [Monthly] [Yearly (17% off)]  (Toggle)                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚  â”‚  â”‚  Feature Comparison Table                  â”‚             â”‚   â”‚
â”‚  â”‚  â”‚  - Clients: 5 | 20 | Unlimited            â”‚             â”‚   â”‚
â”‚  â”‚  â”‚  - Integrations: 10+ | 50+ | 50+ + Custom â”‚             â”‚   â”‚
â”‚  â”‚  â”‚  - White Label: âŒ | âœ… | âœ…               â”‚             â”‚   â”‚
â”‚  â”‚  â”‚  - etc.                                     â”‚             â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚  â”‚  â”‚  FAQ Section (5 Questions)                â”‚             â”‚   â”‚
â”‚  â”‚  â”‚  Payment Modal (After Selection)          â”‚             â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        subscriptionService (TypeScript Service)              â”‚   â”‚
â”‚  â”‚  - createTrialSubscription()                                 â”‚   â”‚
â”‚  â”‚  - createPaymentCheckout()                                   â”‚   â”‚
â”‚  â”‚  - confirmPayment()                                          â”‚   â”‚
â”‚  â”‚  - getCurrentSubscription()                                  â”‚   â”‚
â”‚  â”‚  - cancelSubscription()                                      â”‚   â”‚
â”‚  â”‚  - changePlan()                                              â”‚   â”‚
â”‚  â”‚  - checkTrialExpiry()                                        â”‚   â”‚
â”‚  â”‚  - Helper functions (prices, access checks, etc.)           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚            API Client (api.ts)                               â”‚   â”‚
â”‚  â”‚  - api.post('/subscriptions/create-trial', data)            â”‚   â”‚
â”‚  â”‚  - api.post('/payments/create-checkout', data)              â”‚   â”‚
â”‚  â”‚  - api.post('/payments/confirm', data)                      â”‚   â”‚
â”‚  â”‚  - api.get('/subscriptions/current')                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
                          [HTTPS REST API]
                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BACKEND (Node.js/Express)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Subscription Endpoints (8 Total)                â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  1. POST /api/subscriptions/create-trial                   â”‚   â”‚
â”‚  â”‚     Input: { planId, trialDays, billingCycle }             â”‚   â”‚
â”‚  â”‚     Output: { subscriptionId, subscription }                â”‚   â”‚
â”‚  â”‚     Action: Create trial subscription in db                â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  2. POST /api/payments/create-checkout                     â”‚   â”‚
â”‚  â”‚     Input: { planId, amount, trialPeriodDays }             â”‚   â”‚
â”‚  â”‚     Output: { paymentIntentId, sessionUrl }                 â”‚   â”‚
â”‚  â”‚     Action: Create payment intent, return checkout URL     â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  3. POST /api/payments/confirm                             â”‚   â”‚
â”‚  â”‚     Input: { paymentIntentId, transactionId }              â”‚   â”‚
â”‚  â”‚     Output: { subscription, message }                       â”‚   â”‚
â”‚  â”‚     Action: Validate payment, activate subscription        â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  4. GET /api/subscriptions/current                         â”‚   â”‚
â”‚  â”‚     Output: { subscription }                                â”‚   â”‚
â”‚  â”‚     Action: Return current subscription + trial days left  â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  5. POST /api/subscriptions/cancel                         â”‚   â”‚
â”‚  â”‚     Output: { success, message }                            â”‚   â”‚
â”‚  â”‚     Action: Cancel active subscription                     â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  6. POST /api/subscriptions/change-plan                    â”‚   â”‚
â”‚  â”‚     Input: { newPlanId, billingCycle }                     â”‚   â”‚
â”‚  â”‚     Output: { subscription, message }                       â”‚   â”‚
â”‚  â”‚     Action: Upgrade/downgrade plan                         â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  7. POST /api/subscriptions/check-trial-expiry             â”‚   â”‚
â”‚  â”‚     Output: { expired, daysRemaining }                      â”‚   â”‚
â”‚  â”‚     Action: Check if trial has ended                       â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  8. [Future] Webhook handlers for payment confirmation     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Middleware & Security                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  requireAuth - JWT validation on all endpoints      â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  apiLimiter - Rate limit: 100 req/15min            â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  Validation - Check request fields with validator  â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  Audit Logging - Log all subscription events       â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         checkTrialAndSubscription Middleware                â”‚   â”‚
â”‚  â”‚  - Runs on all protected endpoints                          â”‚   â”‚
â”‚  â”‚  - Checks user's subscription status                        â”‚   â”‚
â”‚  â”‚  - Allows access if: trial active OR subscription active   â”‚   â”‚
â”‚  â”‚  - Blocks access if: trial expired AND no payment         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  DATABASE (JSON File: db.json)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  users[]                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ id, email, password (hashed), subscription fields  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ isTrial, subscriptionId, subscriptionPlan, etc.    â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  subscriptions[] â­ NEW                                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ id, userId, planId, billingCycle                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ status: 'trial'|'active'|'expired'|'cancelled'    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ trialStartsAt, trialEndsAt (for trial subscriptions) â”‚   â”‚
â”‚  â”‚  â”‚ startDate, nextBillingDate (for active)            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ amount, transactionId, createdAt, updatedAt        â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  paymentIntents[] â­ NEW                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ id, userId, planId, amount                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ status: 'pending'|'succeeded'|'failed'             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ email, createdAt, expiresAt                        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ transactionId (populated after confirmation)        â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  planChanges[] â­ NEW                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ id, subscriptionId, userId                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ fromPlan â†’ toPlan (upgrade/downgrade history)      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ fromBilling â†’ toBilling                            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ status: 'pending'|'completed', changedAt           â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  auditLogs[] (Enhanced with subscription events)            â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ Logs:                                               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ - SUBSCRIPTION_TRIAL_CREATED                        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ - PAYMENT_INTENT_CREATED                            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ - PAYMENT_CONFIRMED                                 â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ - SUBSCRIPTION_CANCELLED                            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ - SUBSCRIPTION_PLAN_CHANGED                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ - TRIAL_EXPIRED                                     â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“ (Future)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PAYMENT GATEWAYS (Integrations Ready)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    STRIPE    â”‚        â”‚   M-PESA     â”‚       â”‚ BANK TRANSFERâ”‚   â”‚
â”‚  â”‚              â”‚        â”‚              â”‚       â”‚              â”‚   â”‚
â”‚  â”‚ Credit Cards â”‚        â”‚ Mobile Money â”‚       â”‚ Direct Bank  â”‚   â”‚
â”‚  â”‚ Webhooks âœ“   â”‚        â”‚ STK Push âœ“   â”‚       â”‚ Transfer âœ“   â”‚   â”‚
â”‚  â”‚ Recurring âœ“  â”‚        â”‚ Confirmed âœ“  â”‚       â”‚ Manual âœ“     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â”‚  Integration Status: READY (keys in .env)                           â”‚
â”‚  Current Mode: MOCK (demo/development)                              â”‚
â”‚  Production Mode: ENABLED (via environment config)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Diagram

### Trial Creation Flow
```
User clicks "Start with 7-Day Trial"
         â†“
Frontend: subscriptionService.createTrialSubscription()
         â†“
POST /api/subscriptions/create-trial
  {planId: 'agency', trialDays: 7, billingCycle: 'monthly'}
         â†“
Backend: Validate auth + rate limit
         â†“
Create subscription object:
  {
    id: 'sub_xxx',
    userId: 'user_xxx',
    planId: 'agency',
    status: 'trial',
    trialEndsAt: now + 7 days,
    createdAt: now
  }
         â†“
Save to db.subscriptions[]
Audit log: 'SUBSCRIPTION_TRIAL_CREATED'
Update user: isTrial = true
Save db.json
         â†“
Response: { success: true, subscriptionId: 'sub_xxx' }
         â†“
Frontend: Show success message or payment modal
         â†“
User gets FULL ACCESS for 7 days
```

### Payment Confirmation Flow
```
User day 7: Subscription status checked
         â†“
checkTrialExpiry() returns: { expired: true }
         â†“
Show payment required banner
User clicks "Complete Payment"
         â†“
Frontend: subscriptionService.createPaymentCheckout()
         â†“
POST /api/payments/create-checkout
  {planId: 'agency', amount: 7500, trialPeriodDays: 7}
         â†“
Backend: Create paymentIntent object
Save to db.paymentIntents[]
Return checkout URL
         â†“
Frontend: Redirect to payment gateway
         (Stripe form / M-Pesa STK / Bank details)
         â†“
User completes payment in gateway
Gateway redirects back: ?transactionId=txn_xxx
         â†“
Frontend: subscriptionService.confirmPayment()
         â†“
POST /api/payments/confirm
  {paymentIntentId: 'pi_xxx', transactionId: 'txn_xxx'}
         â†“
Backend: Validate payment
Update paymentIntent: status = 'succeeded'
Create new subscription:
  {
    id: 'sub_yyy',
    userId: 'user_xxx',
    status: 'active',
    nextBillingDate: now + 30 days,
    amount: 7500
  }
         â†“
Update user: isTrial = false, subscriptionPlan = 'agency'
Audit log: 'PAYMENT_CONFIRMED'
Save db.json
         â†“
Response: { success: true, subscription: {...} }
         â†“
Frontend: Show "Payment successful" message
User: ZERO INTERRUPTION - Full access continues
```

---

## State Transitions

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   NO PLAN    â”‚ (User just signed up)
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                             â”‚
                    User starts trial
                             â”‚
                             â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  TRIAL (7 days)  â”‚ â† Full access, countdown
                    â”‚  status='trial'  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚              â”‚              â”‚
        Cancel     Day 7 arrives    Continue
              â”‚              â”‚              â”‚
              â†“              â†“              â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚CANCELLEDâ”‚  â”‚EXPIRED      â”‚  â”‚ACTIVE    â”‚
        â”‚(No      â”‚  â”‚(No access,  â”‚  â”‚(Full     â”‚
        â”‚access)  â”‚  â”‚ payment due)â”‚  â”‚access)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                           â”‚               â”‚
                    User pays        Auto-renew or
                           â”‚        User pays again
                           â†“               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
                    â”‚ACTIVE       â”‚â—„â”€â”€â”€â”€â”€â”€â”˜
                    â”‚(Recurring)  â”‚
                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                   User cancels
                          â”‚
                          â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚CANCELLED    â”‚
                    â”‚(No access)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Security Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 SECURITY LAYERS                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  Layer 1: HTTPS/TLS                                    â”‚
â”‚  â””â”€ All traffic encrypted in transit                   â”‚
â”‚                                                         â”‚
â”‚  Layer 2: Authentication (JWT)                         â”‚
â”‚  â”œâ”€ All endpoints require valid JWT token              â”‚
â”‚  â”œâ”€ Token expires: 15 min (access), 7 days (refresh)  â”‚
â”‚  â””â”€ Tokens signed with JWT_SECRET                      â”‚
â”‚                                                         â”‚
â”‚  Layer 3: Authorization (RBAC)                         â”‚
â”‚  â”œâ”€ Users can only access own subscriptions            â”‚
â”‚  â”œâ”€ Admin endpoints require ADMIN role                 â”‚
â”‚  â””â”€ Checked via req.user.id in middleware              â”‚
â”‚                                                         â”‚
â”‚  Layer 4: Rate Limiting                                â”‚
â”‚  â”œâ”€ Payment endpoints: 100 req/15 min per user         â”‚
â”‚  â”œâ”€ Auth endpoints: 5 req/15 min per IP                â”‚
â”‚  â””â”€ Prevents brute force & DoS                         â”‚
â”‚                                                         â”‚
â”‚  Layer 5: Input Validation                             â”‚
â”‚  â”œâ”€ All POST/PUT data validated with express-validator â”‚
â”‚  â”œâ”€ Email, phone, amount checked                       â”‚
â”‚  â””â”€ Invalid requests rejected (400)                    â”‚
â”‚                                                         â”‚
â”‚  Layer 6: Data Encryption                              â”‚
â”‚  â”œâ”€ OAuth tokens: AES-256-GCM encrypted               â”‚
â”‚  â”œâ”€ Passwords: bcrypt (10 rounds)                      â”‚
â”‚  â””â”€ Sensitive fields never logged                      â”‚
â”‚                                                         â”‚
â”‚  Layer 7: Audit Logging                                â”‚
â”‚  â”œâ”€ Every subscription event logged                    â”‚
â”‚  â”œâ”€ Timestamp, user, action, context                   â”‚
â”‚  â””â”€ Queryable for compliance & debugging               â”‚
â”‚                                                         â”‚
â”‚  Layer 8: CORS Protection                              â”‚
â”‚  â”œâ”€ Only whitelisted origins allowed                   â”‚
â”‚  â”œâ”€ Credentials required for cross-origin              â”‚
â”‚  â””â”€ Prevents unauthorized API access                   â”‚
â”‚                                                         â”‚
â”‚  Layer 9: GDPR Compliance                              â”‚
â”‚  â”œâ”€ GET /api/gdpr/export-data (user data export)       â”‚
â”‚  â”œâ”€ DELETE /api/gdpr/delete-account (full deletion)    â”‚
â”‚  â””â”€ Audit trail maintained for compliance              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Database Schema

```
db.json
â”œâ”€â”€ users[]
â”‚   â”œâ”€â”€ id: string
â”‚   â”œâ”€â”€ email: string
â”‚   â”œâ”€â”€ password: string (bcrypt hashed)
â”‚   â”œâ”€â”€ isTrial: boolean â­ NEW
â”‚   â”œâ”€â”€ trialEndsAt: ISO timestamp â­ NEW
â”‚   â”œâ”€â”€ subscriptionId: string â­ NEW
â”‚   â”œâ”€â”€ subscriptionPlan: string â­ NEW
â”‚   â”œâ”€â”€ subscriptionStatus: string â­ NEW
â”‚   â””â”€â”€ ...other fields
â”‚
â”œâ”€â”€ subscriptions[] â­ NEW COLLECTION
â”‚   â”œâ”€â”€ id: string (sub_xxx)
â”‚   â”œâ”€â”€ userId: string
â”‚   â”œâ”€â”€ planId: 'starter'|'agency'|'enterprise'
â”‚   â”œâ”€â”€ billingCycle: 'monthly'|'yearly'
â”‚   â”œâ”€â”€ status: 'trial'|'active'|'expired'|'cancelled'
â”‚   â”œâ”€â”€ trialStartsAt: ISO timestamp
â”‚   â”œâ”€â”€ trialEndsAt: ISO timestamp
â”‚   â”œâ”€â”€ startDate: ISO timestamp
â”‚   â”œâ”€â”€ nextBillingDate: ISO timestamp
â”‚   â”œâ”€â”€ amount: number (KES)
â”‚   â”œâ”€â”€ paymentIntentId: string
â”‚   â”œâ”€â”€ transactionId: string
â”‚   â”œâ”€â”€ createdAt: ISO timestamp
â”‚   â”œâ”€â”€ updatedAt: ISO timestamp
â”‚   â””â”€â”€ cancelledAt: ISO timestamp
â”‚
â”œâ”€â”€ paymentIntents[] â­ NEW COLLECTION
â”‚   â”œâ”€â”€ id: string (pi_xxx)
â”‚   â”œâ”€â”€ userId: string
â”‚   â”œâ”€â”€ planId: string
â”‚   â”œâ”€â”€ billingCycle: string
â”‚   â”œâ”€â”€ amount: number
â”‚   â”œâ”€â”€ status: 'pending'|'succeeded'|'failed'
â”‚   â”œâ”€â”€ email: string
â”‚   â”œâ”€â”€ createdAt: ISO timestamp
â”‚   â”œâ”€â”€ expiresAt: ISO timestamp
â”‚   â”œâ”€â”€ confirmedAt: ISO timestamp
â”‚   â””â”€â”€ transactionId: string
â”‚
â”œâ”€â”€ planChanges[] â­ NEW COLLECTION
â”‚   â”œâ”€â”€ id: string
â”‚   â”œâ”€â”€ subscriptionId: string
â”‚   â”œâ”€â”€ userId: string
â”‚   â”œâ”€â”€ fromPlan: string
â”‚   â”œâ”€â”€ toPlan: string
â”‚   â”œâ”€â”€ fromBilling: string
â”‚   â”œâ”€â”€ toBilling: string
â”‚   â”œâ”€â”€ status: 'pending'|'completed'
â”‚   â””â”€â”€ changedAt: ISO timestamp
â”‚
â”œâ”€â”€ auditLogs[] (Enhanced)
â”‚   â”œâ”€â”€ id: string
â”‚   â”œâ”€â”€ action: string (new: SUBSCRIPTION_* events)
â”‚   â”œâ”€â”€ userId: string
â”‚   â”œâ”€â”€ timestamp: ISO timestamp
â”‚   â”œâ”€â”€ context: object
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ ...other collections
```

---

## API Response Examples

### Create Trial - Success
```json
{
  "success": true,
  "subscriptionId": "sub_1704201600123_abc123",
  "subscription": {
    "id": "sub_1704201600123_abc123",
    "userId": "user_67890",
    "planId": "agency",
    "billingCycle": "monthly",
    "status": "trial",
    "trialStartsAt": "2025-01-01T12:00:00Z",
    "trialEndsAt": "2025-01-08T12:00:00Z",
    "paymentStartDate": "2025-01-08T12:00:00Z",
    "createdAt": "2025-01-01T12:00:00Z"
  }
}
```

### Get Current Subscription
```json
{
  "subscription": {
    "id": "sub_1704201600123_abc123",
    "userId": "user_67890",
    "planId": "agency",
    "billingCycle": "monthly",
    "status": "trial",
    "trialDaysRemaining": 5,
    "trialEndsAt": "2025-01-08T12:00:00Z",
    "createdAt": "2025-01-01T12:00:00Z"
  }
}
```

### Check Trial Expiry
```json
{
  "expired": false,
  "trialActive": true,
  "daysRemaining": 2,
  "trialEndsAt": "2025-01-08T12:00:00Z"
}
```

---

## Summary

This architecture provides:
- âœ… **Scalability:** Stateless API, JSON storage (upgradeable to SQL)
- âœ… **Security:** Multi-layer protection, encryption, rate limiting
- âœ… **Compliance:** GDPR endpoints, audit logging
- âœ… **Reliability:** Error handling, validation, transaction tracking
- âœ… **Maintainability:** Clear separation of concerns, well-documented
- âœ… **Performance:** Efficient queries, caching ready
- âœ… **Extensibility:** Ready for payment gateway webhooks, scheduled tasks

